<!-- templates/index.html -->
<!DOCTYPE html>
<html>
<head>
    <title>流式多Agent多模态数据处理框架</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.min.js" integrity="sha512-BLVfFyaxQpSlVuIyLXapBn4PDAOSj/H9OmGX+HSSV/0Dyo/2qXkdkKcYCr+eIgqvG+8Xy2j04eSGL1jmKVIC7A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        #config {
            margin-bottom: 20px;
        }
        .form-section {
            margin-bottom: 15px;
        }
        #graph {
            border: 1px solid #ccc;
            width: 100%;
            height: 600px;
        }
    </style>
</head>
<body>
    <h1>流式多Agent多模态数据处理框架</h1>

    <div id="config">
        <h2>配置管理</h2>
        <div class="form-section">
            <h3>添加 Stream</h3>
            <input type="text" id="stream_name" placeholder="Stream 名称">
            <button onclick="addStream()">添加 Stream</button>
        </div>
        <div class="form-section">
            <h3>添加 Agent</h3>
            <input type="text" id="agent_name" placeholder="Agent 名称">
            <input type="text" id="agent_key" placeholder="LLM API Key">
            <input type="text" id="agent_streams" placeholder="订阅 Streams (逗号分隔)">
            <button onclick="addAgent()">添加 Agent</button>
        </div>
        <div class="form-section">
            <h3>发射数据</h3>
            <input type="text" id="emit_stream" placeholder="Stream 名称">
            <input type="text" id="emit_data" placeholder="数据">
            <button onclick="emitData()">发射数据</button>
        </div>
    </div>

    <div id="graph">
        <!-- D3.js 图表将渲染在此 -->
    </div>

    <script>
        var socket = io();

        // 数据结构
        var nodes = [];
        var links = [];

        // D3.js 初始化
        var width = document.getElementById('graph').clientWidth;
        var height = document.getElementById('graph').clientHeight;

        var svg = d3.select("#graph").append("svg")
            .attr("width", width)
            .attr("height", height);

        var simulation = d3.forceSimulation(nodes)
            .force("link", d3.forceLink(links).id(d => d.id).distance(200))
            .force("charge", d3.forceManyBody().strength(-500))
            .force("center", d3.forceCenter(width / 2, height / 2));

        var link = svg.append("g")
            .attr("stroke", "#999")
            .attr("stroke-opacity", 0.6)
          .selectAll("line")
          .data(links)
          .enter().append("line")
            .attr("stroke-width", 2);

        var node = svg.append("g")
            .attr("stroke", "#fff")
            .attr("stroke-width", 1.5)
          .selectAll("circle")
          .data(nodes)
          .enter().append("circle")
            .attr("r", 20)
            .attr("fill", "#69b3a2")
            .call(drag(simulation));

        var label = svg.append("g")
            .selectAll("text")
            .data(nodes)
            .enter().append("text")
            .attr("dy", -25)
            .attr("text-anchor", "middle")
            .text(d => d.id);

        simulation.on("tick", () => {
            link
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);

            node
                .attr("cx", d => d.x)
                .attr("cy", d => d.y);

            label
                .attr("x", d => d.x)
                .attr("y", d => d.y);
        });

        function drag(simulation) {
            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }

            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }

            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }

            return d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended);
        }

        // 添加Stream到图表
        function addStreamToGraph(streamName) {
            if (!nodes.find(n => n.id === streamName)) {
                nodes.push({id: streamName, type: 'stream'});
                updateGraph();
            }
        }

        // 添加Agent到图表
        function addAgentToGraph(agentName) {
            if (!nodes.find(n => n.id === agentName)) {
                nodes.push({id: agentName, type: 'agent'});
                updateGraph();
            }
        }

        // 更新图表
        function updateGraph() {
            link = link.data(links);
            link.exit().remove();
            link = link.enter().append("line")
                .attr("stroke-width", 2)
                .merge(link);

            node = node.data(nodes);
            node.exit().remove();
            node = node.enter().append("circle")
                .attr("r", 20)
                .attr("fill", d => d.type === 'stream' ? '#69b3a2' : '#ff7f0e')
                .call(drag(simulation))
                .merge(node);

            label = label.data(nodes);
            label.exit().remove();
            label = label.enter().append("text")
                .attr("dy", -25)
                .attr("text-anchor", "middle")
                .text(d => d.id)
                .merge(label);

            simulation.nodes(nodes);
            simulation.force("link").links(links);
            simulation.alpha(1).restart();
        }

        // SocketIO事件处理
        socket.on('data_flow', function(msg) {
            console.log('Data Flow:', msg);
            // 根据事件更新图表或显示数据流动
            // 这里可以扩展更复杂的可视化逻辑
        });

        socket.on('agent_response', function(msg) {
            console.log('Agent Response:', msg);
            // 可以在UI中显示Agent的响应
        });

        // 添加Stream函数
        function addStream() {
            var streamName = document.getElementById('stream_name').value.trim();
            if (!streamName) {
                alert('Stream名称不能为空');
                return;
            }
            fetch('/add_stream', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name: streamName})
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    addStreamToGraph(streamName);
                    alert(`Stream ${streamName} 添加成功`);
                } else {
                    alert(`错误: ${data.message}`);
                }
            });
        }

        // 添加Agent函数
        function addAgent() {
            var agentName = document.getElementById('agent_name').value.trim();
            var agentKey = document.getElementById('agent_key').value.trim();
            var agentStreams = document.getElementById('agent_streams').value.trim().split(',').map(s => s.trim()).filter(s => s);

            if (!agentName || !agentKey) {
                alert('Agent名称和LLM API Key不能为空');
                return;
            }

            fetch('/add_agent', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    name: agentName,
                    llm_api_key: agentKey,
                    subscribed_streams: agentStreams
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    addAgentToGraph(agentName);
                    // 创建连接线
                    agentStreams.forEach(streamName => {
                        links.push({source: streamName, target: agentName});
                    });
                    updateGraph();
                    alert(`Agent ${agentName} 添加成功`);
                } else {
                    alert(`错误: ${data.message}`);
                }
            });
        }

        // 发射数据函数
        function emitData() {
            var streamName = document.getElementById('emit_stream').value.trim();
            var data = document.getElementById('emit_data').value.trim();

            if (!streamName || !data) {
                alert('Stream名称和数据不能为空');
                return;
            }

            fetch('/emit_data', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    stream: streamName,
                    data: data
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert(`数据已发射到Stream ${streamName}`);
                } else {
                    alert(`错误: ${data.message}`);
                }
            });
        }
    </script>
</body>
</html>
